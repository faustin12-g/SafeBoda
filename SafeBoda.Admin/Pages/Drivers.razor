@page "/drivers"
@using SafeBoda.Admin.Shared
@inject SafeBoda.Admin.Services.AuthService AuthService
@inject SafeBoda.Admin.Services.ApiClient ApiClient
@inject IJSRuntime JSRuntime

<AdminLayout CurrentPage="drivers">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="fw-bold mb-1">Registered Drivers</h4>
                    <p class="text-muted mb-0">View and manage all registered drivers</p>
                </div>
                <div>
                    <button class="btn btn-safeboda me-2" @onclick="ShowCreateModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Driver
                    </button>
                    <button class="btn btn-outline-success" @onclick="LoadDrivers">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Search Bar and Page Size Selector -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" 
                               class="form-control border-start-0 ps-0" 
                               placeholder="Search by name, phone number, or plate number..." 
                               value="@searchTerm"
                               @oninput="OnSearchInput"
                               style="box-shadow: none;">
                        @if (!string.IsNullOrWhiteSpace(searchTerm))
                        {
                            <button class="btn btn-outline-secondary" @onclick="ClearSearch" type="button">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <label class="me-2 text-nowrap">Items per page:</label>
                                <select class="form-select" @onchange="OnPageSizeChanged">
                                    <option value="10" selected="@(pageSize == 10)">10</option>
                                    <option value="50" selected="@(pageSize == 50)">50</option>
                                    <option value="100" selected="@(pageSize == 100)">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-success" role="status"></div>
                    <p class="mt-3 text-muted">Loading drivers...</p>
                </div>
            }
            else if (filteredDrivers == null || !filteredDrivers.Any())
            {
                <div class="card p-5 text-center">
                    <i class="bi bi-people" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h5 class="mt-3 text-muted">No Drivers Found</h5>
                    <p class="text-muted mb-0">
                        @if (!string.IsNullOrWhiteSpace(searchTerm))
                        {
                            <text>No drivers match your search criteria. Try a different search term.</text>
                        }
                        else
                        {
                            <text>There are currently no registered drivers in the system.</text>
                        }
                    </p>
                </div>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var driver in paginatedDrivers)
                    {
                        <div class="col-md-6 col-lg-4">
                            <div class="card p-4 h-100" style="position: relative;">
                                <!-- Three-dot menu -->
                                <div class="dropdown" style="position: absolute; top: 16px; right: 16px;">
                                    <button class="btn btn-sm btn-link text-muted p-0" 
                                            type="button" 
                                            @onclick="() => ToggleDropdown(driver.Id)"
                                            style="font-size: 1.2rem; line-height: 1; text-decoration: none;">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    @if (openDropdownId == driver.Id)
                                    {
                                        <div class="dropdown-menu show" style="position: absolute; right: 0; top: 100%; z-index: 1000;">
                                            <button class="dropdown-item" @onclick="() => { ShowEditModal(driver); CloseDropdown(); }">
                                                <i class="bi bi-pencil me-2"></i>Edit
                                            </button>
                                            <button class="dropdown-item text-danger" @onclick="async () => { await DeleteDriver(driver.Id); CloseDropdown(); }">
                                                <i class="bi bi-trash me-2"></i>Delete
                                            </button>
                                        </div>
                                    }
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-3"
                                         style="width: 50px; height: 50px; background: var(--safeboda-green-light);">
                                        <i class="bi bi-person-fill" style="color: var(--safeboda-green); font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold">@driver.Name</h6>
                                        <small class="text-muted">Driver</small>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-telephone me-2 text-muted"></i>
                                    <span>@driver.PhoneNumber</span>
                                </div>
                                <div>
                                    <i class="bi bi-bicycle me-2 text-muted"></i>
                                    <span class="badge bg-dark">@driver.MotoPlateNumber</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination Controls -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                Showing @GetStartItem() to @GetEndItem() of @filteredDrivers.Count driver(s)
                                @if (!string.IsNullOrWhiteSpace(searchTerm))
                                {
                                    <span class="ms-2">
                                        <i class="bi bi-funnel me-1"></i>Filtered
                                    </span>
                                }
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                                            <i class="bi bi-chevron-left"></i> Previous
                                        </button>
                                    </li>
                                    @foreach (var pageNum in GetPageNumbers())
                                    {
                                        @if (pageNum == -1)
                                        {
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        }
                                        else
                                        {
                                            var pageNumber = pageNum;
                                            <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                                <button class="page-link" @onclick="() => GoToPage(pageNumber)">@pageNumber</button>
                                            </li>
                                        }
                                    }
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                                            Next <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            }


    @if (showModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isEditMode ? "Edit Driver" : "Add New Driver")</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" @bind="currentDriver.Name" placeholder="Enter driver name" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="text" class="form-control" @bind="currentDriver.PhoneNumber" placeholder="+250788123456" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Moto Plate Number</label>
                            <input type="text" class="form-control" @bind="currentDriver.MotoPlateNumber" placeholder="RAD-001-A" />
                        </div>
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="button" class="btn btn-safeboda" @onclick="SaveDriver" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            @(isEditMode ? "Update" : "Create")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</AdminLayout>

@code {
    private bool isLoading = true;
    private List<SafeBoda.Admin.Models.Driver> drivers = new();
    private List<SafeBoda.Admin.Models.Driver> filteredDrivers = new();
    private List<SafeBoda.Admin.Models.Driver> paginatedDrivers = new();
    private string searchTerm = string.Empty;
    private bool showModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private SafeBoda.Admin.Models.Driver currentDriver = new();
    private Guid openDropdownId = Guid.Empty;
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling((double)filteredDrivers.Count / pageSize);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDrivers();
            StateHasChanged();
        }
    }

    private async Task LoadDrivers()
    {
        isLoading = true;
        StateHasChanged();

        drivers = await ApiClient.GetDriversAsync();
        FilterDrivers();
        UpdatePagination();
        
        isLoading = false;
        StateHasChanged();
    }

    private void FilterDrivers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredDrivers = drivers;
        }
        else
        {
            var search = searchTerm.ToLower();
            filteredDrivers = drivers.Where(d =>
                (d.Name?.ToLower().Contains(search) ?? false) ||
                (d.PhoneNumber?.ToLower().Contains(search) ?? false) ||
                (d.MotoPlateNumber?.ToLower().Contains(search) ?? false)
            ).ToList();
        }
        currentPage = 1;
        UpdatePagination();
    }

    private void UpdatePagination()
    {
        var skip = (currentPage - 1) * pageSize;
        paginatedDrivers = filteredDrivers.Skip(skip).Take(pageSize).ToList();
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        UpdatePagination();
    }

    private void OnPageSizeChanged(ChangeEventArgs e)
    {
        pageSize = int.Parse(e.Value?.ToString() ?? "10");
        currentPage = 1;
        UpdatePagination();
    }

    private int GetStartItem()
    {
        if (!filteredDrivers.Any()) return 0;
        return ((currentPage - 1) * pageSize) + 1;
    }

    private int GetEndItem()
    {
        var end = currentPage * pageSize;
        return Math.Min(end, filteredDrivers.Count);
    }

    private List<int> GetPageNumbers()
    {
        var pages = new List<int>();
        if (totalPages <= 7)
        {
            for (int i = 1; i <= totalPages; i++)
                pages.Add(i);
        }
        else
        {
            if (currentPage <= 4)
            {
                for (int i = 1; i <= 5; i++)
                    pages.Add(i);
                pages.Add(-1);
                pages.Add(totalPages);
            }
            else if (currentPage >= totalPages - 3)
            {
                pages.Add(1);
                pages.Add(-1);
                for (int i = totalPages - 4; i <= totalPages; i++)
                    pages.Add(i);
            }
            else
            {
                pages.Add(1);
                pages.Add(-1);
                for (int i = currentPage - 1; i <= currentPage + 1; i++)
                    pages.Add(i);
                pages.Add(-1);
                pages.Add(totalPages);
            }
        }
        return pages;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        FilterDrivers();
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        FilterDrivers();
    }

    private void ToggleDropdown(Guid driverId)
    {
        openDropdownId = openDropdownId == driverId ? Guid.Empty : driverId;
    }

    private void CloseDropdown()
    {
        openDropdownId = Guid.Empty;
    }

    private void ShowCreateModal()
    {
        isEditMode = false;
        currentDriver = new SafeBoda.Admin.Models.Driver();
        errorMessage = string.Empty;
        showModal = true;
    }

    private void ShowEditModal(SafeBoda.Admin.Models.Driver driver)
    {
        isEditMode = true;
        currentDriver = new SafeBoda.Admin.Models.Driver
        {
            Id = driver.Id,
            Name = driver.Name,
            PhoneNumber = driver.PhoneNumber,
            MotoPlateNumber = driver.MotoPlateNumber
        };
        errorMessage = string.Empty;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentDriver = new();
        errorMessage = string.Empty;
    }

    private async Task SaveDriver()
    {
        if (string.IsNullOrWhiteSpace(currentDriver.Name) || 
            string.IsNullOrWhiteSpace(currentDriver.PhoneNumber) || 
            string.IsNullOrWhiteSpace(currentDriver.MotoPlateNumber))
        {
            errorMessage = "Please fill in all required fields.";
            return;
        }

        isSaving = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            if (isEditMode)
            {
                var result = await ApiClient.UpdateDriverAsync(currentDriver.Id, currentDriver);
                if (result != null)
                {
                    await LoadDrivers();
                    CloseModal();
                }
                else
                {
                    errorMessage = "Failed to update driver. Please try again.";
                }
            }
            else
            {
                var result = await ApiClient.CreateDriverAsync(currentDriver);
                if (result != null)
                {
                    await LoadDrivers();
                    CloseModal();
                }
                else
                {
                    errorMessage = "Failed to create driver. Please try again.";
                }
            }
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DeleteDriver(Guid driverId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this driver?"))
        {
            return;
        }

        var success = await ApiClient.DeleteDriverAsync(driverId);
        if (success)
        {
            await LoadDrivers();
        }
    }

}
